---
title: "PCA_Explore"
author: "Patrizio Bertoni"
date: "31 December 2015"
output: html_document
---

--------------------------------------------------------------------------------

Following my introduction to PCA, I will demonstrate how to apply and visualize PCA in R. There are many packages and functions that can apply PCA in R. In this post I will use the function `prcomp` from the `stats` package. I will also show how to visualize PCA in R using Base R graphics. However, my favorite visualization function for PCA is `ggbiplot`, which is implemented by Vince Q. Vu and available on github. Please, let me know if you have better ways to visualize PCA in R.

#### Computing the Principal Components (PC)

I will use the classical `iris` dataset for the demonstration. The data contain four continuous variables which corresponds to physical measures of flowers and a categorical variable describing the flowers' species.

```{r}
# Load data
data(iris)
head(iris, 3)
```

We will apply PCA to the four continuous variables and use the categorical variable to visualize the PCs later. Notice that in the following code we apply a log transformation to the continuous variables as suggested by [1] and set center and scale. equal to TRUE in the call to prcomp to standardize the variables prior to the application of PCA:

```{r}
# log transform 
log.ir <- log(iris[, 1:4])
ir.species <- iris[, 5]
 
# apply PCA - scale. = TRUE is highly 
# advisable, but default is FALSE. 
ir.pca <- prcomp(log.ir,
                 center = TRUE,
                 scale. = TRUE) 
```

Since skewness and the magnitude of the variables influence the resulting PCs, it is good practice to apply skewness transformation, center and scale the variables prior to the application of PCA. In the example above, we applied a log transformation to the variables but we could have been more general and applied a Box and Cox transformation [2]. See at the end of this post how to perform all those transformations and then apply PCA with only one call to the preProcess function of the caret package.

#### Analyzing the results

The prcomp function returns an object of class prcomp, which have some methods available. The print method returns the standard deviation of each of the four PCs, and their rotation (or loadings), which are the coefficients of the linear combinations of the continuous variables.

```{r}
# print method
print(ir.pca)
```

The plot method returns a plot of the variances (y-axis) associated with the PCs (x-axis). The Figure below is useful to decide how many PCs to retain for further analysis. In this simple case with only 4 PCs this is not a hard task and we can see that the first two PCs explain most of the variability in the data.

```{r}
# plot method
plot(ir.pca, type = "l")
```

The summary method describe the importance of the PCs. The first row describe again the standard deviation associated with each PC. The second row shows the proportion of the variance in the data explained by each component while the third row describe the cumulative proportion of explained variance. We can see there that the first two PCs accounts for more than {95\%} of the variance of the data.

```{r}
# summary method
summary(ir.pca)
```

We can use the predict function if we observe new data and want to predict their PCs values. Just for illustration pretend the last two rows of the iris data has just arrived and we want to see what is their PCs values:

```{r}
# Predict PCs
predict(ir.pca, newdata=tail(log.ir, 2))
```

#### Installing ggbiplot from github

First of this, remember to `install.packages("devtools", repos = 'http://cran.us.r-project.org')` and, after loading it with `library("devtools")`, install *ggbiplot* with `install_github("ggbiplot", "vqv")`.

```{r}
library("devtools")
library(ggbiplot)

g <- ggbiplot(ir.pca, obs.scale = 1, var.scale = 1, 
              groups = ir.species, ellipse = TRUE, 
              circle = TRUE)
g <- g + scale_color_discrete(name = '')
g <- g + theme(legend.direction = 'horizontal', 
               legend.position = 'top')
print(g)
```

It projects the data on the first two PCs. Other PCs can be chosen through the argument choices of the function. It colors each point according to the flowers' species and draws a Normal contour line with ellipse.prob probability (default to {68\%}) for each group. More info about ggbiplot can be obtained by the usual ?ggbiplot. I think you will agree that the plot produced by ggbiplot is much better than the one produced by biplot(ir.pca)

### PCA on caret package

As I mentioned before, it is possible to first apply a Box-Cox transformation to correct for skewness, center and scale each variable and then apply PCA in one call to the preProcess function of the caret package.

Do not forget to `install.packages("caret")` and `install.packages("e1071")`.

```{r}
require(caret)
trans = preProcess(iris[,1:4], 
                   method=c("BoxCox", "center", 
                            "scale", "pca"))
PC = predict(trans, iris[,1:4])
```

By default, the function keeps only the PCs that are necessary to explain at least 95% of the variability in the data, but this can be changed through the argument thresh.

```{r}
# Retained PCs
head(PC, 3)
# Loadings
trans$rotation
```

See [Unsupervised data pre-processing for predictive modeling](https://tgmstat.wordpress.com/2013/11/07/unsupervised-data-pre-processing-for-predictive-modeling) for an introduction of the preProcess function.

# Gaston Sanchez's guide to FactoMineR's PCA()

A highly recommended option, especially if you want more detailed results and assessing tools, is the `PCA()` function from the package `"FactoMineR"`. It is by far the best PCA function in R and it comes with a number of parameters that allow you to tweak the analysis in a very nice way.

So `install.packages("FactoMineR")`

```{r}
# PCA with function PCA
library(FactoMineR)

# apply PCA
pca3 = PCA(USArrests, graph = FALSE)

# matrix with eigenvalues
pca3$eig
```

```{r}
# correlations between variables and PCs
pca3$var$coord
```

```{r}
# PCs (aka scores)
head(pca3$ind$coord)
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```
